===========================================================================================
Project: Cohort Analysis of Online Cinema Using SQL< / Проект: Когортный анализ онлайн-кинотеатра с помощью SQL
===========================================================================================


I needed to plot the distribution of money paid out by customers in an online movie theater by month.
Complete the query to get three different moving averages (by amount of money by month): a. MA(3) is a moving average, taking the current value and the two previous values. b. MA(7) is a moving average taking the current value and the six previous ones. c. MA_2side(5) - a two-sided moving average taking the current value, the previous two and the next two.
Visualize the obtained results in Metabase.


*Мне нужно было построить распределение выплаченных клиентами денег в он-лайн-кинотеатре по месяцам.
Дополнить запрос, чтобы получить три разных скользящих средних (по сумме денег по месяцам): a. MA(3) - скользящее среднее, принимающее текущее значение и два предыдущих. b. MA(7) - скользящее среднее, принимающее текущее значение и шесть предыдущих. c. MA_2side(5) - двустороннее скользящее среднее, принимающее текущее значение, два предыдущих и два следующих.
Визуализировать полученные результаты в Metabase.



select t.*
        , avg(sum_pay) over (order by mm rows between 2 preceding and current row) as ma_3
        , avg(sum_pay) over (order by mm rows between 6 preceding and current row) as ma_7
        , avg(sum_pay) over (order by mm rows between 2 preceding and 2 following) as ma_5_2s
from (select   sum(amt_payment) sum_pay
            , date_trunc('month', date_purchase) as mm
     from skycinema.client_sign_up
     group by mm 
     order by mm
     ) t        


